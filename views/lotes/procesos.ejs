<div class="container mt-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/fincas/gestionar">Mis Fincas</a></li>
            <li class="breadcrumb-item"><a href="/fincas/<%= finca.id %>/lotes">Lotes de: <%= finca.nombre %></a></li>
            <li class="breadcrumb-item active" aria-current="page">Procesos Lote: <%= lote.codigo %></li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-toastem-primary"><%= titulo %></h1>
        <div>
            <a href="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/flujo" class="btn me-2" style="background-color: #2c6c7c; color: white;">
                <i class="fas fa-project-diagram me-1"></i> Ver Flujo Completo
            </a>
            

            <div class="btn-group me-2">
                <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog me-1"></i> Acciones
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/duplicar">
                        <i class="fas fa-copy me-1"></i> Duplicar Lote
                    </a></li>
                    <% if (lote.id_estado_proceso !== 4) { %>
                        <li><a class="dropdown-item text-danger" href="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/cancelar">
                            <i class="fas fa-ban me-1"></i> Cancelar Lote
                        </a></li>
                    <% } %>
                </ul>
            </div>
            
            
            <div class="d-flex justify-content-end mt-2">
                <span class="badge fs-6 me-3" style="background-color: #2c6c7c;">Lote Estado: <%= lote.estado_proceso_nombre %></span>
                <span class="badge bg-secondary fs-6">Proceso Actual: <%= lote.proceso_actual_nombre %></span>
            </div>
        </div>
    </div>

        <% if (typeof mensaje !== 'undefined' && mensaje && mensaje.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= mensaje %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>
    
    <% 
    function hayError(error) {
        if (!error) return false;
        
        if (Array.isArray(error)) {
            return error.some(err => err && err.toString().trim() !== '');
        } else if (typeof error === 'string') {
            return error.trim() !== '';
        }
        
        return false;
    }
    %>
    
    <% if (typeof error !== 'undefined' && hayError(error)) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="fas fa-exclamation-triangle me-1"></i> Error:</strong>
            <% if (Array.isArray(error)) { %>
                <ul class="mb-0 ps-3">
                <% error.forEach(function(err) { %>
                    <% if (err && err.toString().trim() !== '') { %>
                        <li><%= Array.isArray(err) ? err.join(', ') : err %></li>
                    <% } %>
                <% }) %>
                </ul>
            <% } else { %>
                <%= error %>
            <% } %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="row">
        <% procesosConEstado.forEach(proceso => { %>
            <div class="col-md-6 col-lg-4 mb-4">
                <% 
                    let etapaInfo = proceso.datosEtapa;
                    let urlFormulario = '#';
                    let urlVer = '#';
                    let urlAccionAdicional = null;
                    let textoAccionAdicional = null;
                    
                    if (proceso.nombre.toLowerCase() === 'despulpado') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/despulpado/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'fermentación y lavado') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/fermentacion-lavado/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'zarandeo') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/zarandeo/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'secado') {
                        if (!etapaInfo) {
                            urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/secado/iniciar`;
                        } else if (etapaInfo.id_estado_proceso === 1 || etapaInfo.id_estado_proceso === 2) { // Registrado o En Progreso
                            urlAccionAdicional = `/fincas/${finca.id}/lotes/${lote.id}/secado/finalizar`;
                            textoAccionAdicional = 'Finalizar Secado';
                            // También puede tener seguimiento si está en progreso
                        } else if (etapaInfo.id_estado_proceso === 3) { // Terminado
                            if (etapaInfo.decision_venta) {
                                urlAccionAdicional = `/fincas/${finca.id}/lotes/${lote.id}/ventas/registrar/pergamino`; // NUEVA RUTA
                                textoAccionAdicional = 'Registrar Venta Pergamino';
                            }
                            // Si está terminado y NO hay decision_venta, podría ir a Clasificación (lógica ya existente más abajo)
                        }
                    } else if (proceso.nombre.toLowerCase() === 'clasificación') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/clasificacion/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'trilla') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/trilla/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'tueste') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/tueste/registrar`;
                    } else if (proceso.nombre.toLowerCase() === 'molienda') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/molienda/registrar`;
                        // Eliminada funcionalidad de venta directa desde Molienda
                    } else if (proceso.nombre.toLowerCase() === 'empacado') {
                        urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/empacado/registrar`;
                        // Si hay productos empacados (etapaInfo.empacados es el array)
                        // y el lote no está cancelado ni finalizado, mostrar opción de vender empacado.
                        if (etapaInfo && etapaInfo.empacados && Array.isArray(etapaInfo.empacados) && etapaInfo.empacados.length > 0 && lote.id_estado_proceso !== 4 && lote.id_estado_proceso !== 5) { 
                            urlAccionAdicional = `/fincas/${finca.id}/lotes/${lote.id}/ventas/registrar/empacado`;
                            textoAccionAdicional = 'Vender Producto Empacado';
                        }
                    } else if (proceso.nombre.toLowerCase() === 'control de calidad') {
                        if (etapaInfo && etapaInfo.enConstruccion) {
                            // No definir urlFormulario ni urlAccionAdicional para que no se muestren botones
                        } else {
                            // Lógica original si en el futuro se habilita CC
                            // urlFormulario = `/fincas/${finca.id}/lotes/${lote.id}/control-calidad/registrar`;
                        }
                    }
                %>
                <div class="card h-100 shadow-sm proceso-card">
                    <div class="card-header bg-toastem-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><%= proceso.nombre %></h5>
                        <span class="badge 
                            <% if (proceso.nombre.toLowerCase() === 'molienda' && Array.isArray(proceso.datosEtapa)) { %>
                                <% if (proceso.datosEtapa.some(m => m.id_estado_proceso === 3)) { %> bg-success
                                <% } else if (proceso.datosEtapa.some(m => m.id_estado_proceso === 2)) { %> bg-warning text-dark
                                <% } else if (proceso.datosEtapa.some(m => m.id_estado_proceso === 1)) { %> bg-info
                                <% } else if (lote.id_proceso_actual === proceso.id && lote.id_estado_proceso === 2) { %> bg-warning text-dark
                                <% } else { %> bg-light text-dark <% } %>
                            <% } else { %>
                                <% if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 3) { %> bg-success
                                <% } else if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2) { %> bg-warning text-dark
                                <% } else if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 1) { %> bg-info
                                <% } else if (lote.id_proceso_actual === proceso.id && lote.id_estado_proceso === 2) { %> bg-warning text-dark
                                <% } else { %> bg-light text-dark <% } %>
                            <% } %>
                        ">
                            <% if (proceso.nombre.toLowerCase() === 'molienda' && Array.isArray(proceso.datosEtapa)) { %>
                                <% if (proceso.datosEtapa.some(m => m.id_estado_proceso === 3)) { %>
                                    Terminado
                                <% } else if (proceso.datosEtapa.some(m => m.id_estado_proceso === 2)) { %>
                                    En Progreso
                                <% } else if (proceso.datosEtapa.some(m => m.id_estado_proceso === 1)) { %>
                                    Reiniciado
                                <% } else if (lote.id_proceso_actual === proceso.id && lote.id_estado_proceso === 2) { %>
                                    En Curso
                                <% } else { %>
                                    Pendiente
                                <% } %>
                            <% } else { %>
                                <% if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 3) { %>
                                    Terminado
                                <% } else if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2) { %>
                                    En Progreso
                                <% } else if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 1) { %>
                                    Registrado
                                <% } else if (lote.id_proceso_actual === proceso.id && lote.id_estado_proceso === 2) { %>
                                    En Curso
                                <% } else { %>
                                    Pendiente
                                <% } %>
                            <% } %>
                        </span>
                    </div>
                    <div class="card-body">
                        <% if (proceso.datosEtapa) { %>
                            <!-- Solo mostrar información general para procesos que NO sean secado -->
                            <% if (proceso.nombre.toLowerCase() !== 'secado') { %>
                                <p class="card-text">
                                    <% if (proceso.datosEtapa.fecha_inicio) { %>
                                        <strong>Fecha inicio:</strong> <%= new Date(proceso.datosEtapa.fecha_inicio).toLocaleDateString() %><br>
                                    <% } %>
                                    <% if (proceso.datosEtapa.fecha_fin) { %>
                                        <strong>Fecha fin:</strong> <%= new Date(proceso.datosEtapa.fecha_fin).toLocaleDateString() %><br>
                                    <% } %>
                                    <% if (proceso.datosEtapa.peso_final) { %>
                                        <strong>Peso final:</strong> <%= proceso.datosEtapa.peso_final %> kg<br>
                                    <% } %>
                                </p>
                            <% } %>
                            
                            <% if (proceso.orden > 1) { %>
                                <% 
                                    // Encontrar el proceso anterior para mostrar su fecha de finalización
                                    const procesoAnteriorOrden = proceso.orden - 1;
                                    const procesoAnterior = procesosConEstado.find(p => p.orden === procesoAnteriorOrden);
                                    
                                    let fechaFinProcesoAnterior = null;
                                    if (procesoAnterior && procesoAnterior.datosEtapa) {
                                        // Determinar la fecha de finalización según el tipo de proceso anterior
                                        if (procesoAnterior.nombre.toLowerCase() === 'recolección') {
                                            fechaFinProcesoAnterior = lote.fecha_recoleccion;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'despulpado' && procesoAnterior.datosEtapa.fecha_despulpado) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_despulpado;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'fermentación y lavado' && procesoAnterior.datosEtapa.fecha_lavado) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_lavado;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'zarandeo' && procesoAnterior.datosEtapa.fecha_zarandeo) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_zarandeo;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'secado' && procesoAnterior.datosEtapa.fecha_fin) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_fin;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'clasificación' && procesoAnterior.datosEtapa.fecha_clasificacion) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_clasificacion;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'trilla' && procesoAnterior.datosEtapa.fecha_trilla) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_trilla;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'tueste' && procesoAnterior.datosEtapa.fecha_tueste) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_tueste;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'molienda' && procesoAnterior.datosEtapa.fecha_molienda) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_molienda;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'empacado' && procesoAnterior.datosEtapa.fecha_empacado) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_empacado;
                                        } else if (procesoAnterior.nombre.toLowerCase() === 'control de calidad' && procesoAnterior.datosEtapa.fecha_control) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_control;
                                        } else if (procesoAnterior.datosEtapa.fecha_fin) {
                                            fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_fin;
                                        }
                                    }
                                %>
                                <% if (fechaFinProcesoAnterior) { %>
                                    <p class="card-text mb-3">
                                        <strong><i class="fas fa-clock text-secondary me-1"></i> Proceso anterior finalizado:</strong> <%= new Date(fechaFinProcesoAnterior).toLocaleString("es-CO") %>
                                    </p>
                                <% } %>
                            <% } %>
                        <% } else if (proceso.orden > 1) { %>
                            <% 
                                // Encontrar el proceso anterior para mostrar su fecha de finalización
                                const procesoAnteriorOrden = proceso.orden - 1;
                                const procesoAnterior = procesosConEstado.find(p => p.orden === procesoAnteriorOrden);
                                
                                let fechaFinProcesoAnterior = null;
                                if (procesoAnterior && procesoAnterior.datosEtapa) {
                                    // Determinar la fecha de finalización según el tipo de proceso anterior
                                    if (procesoAnterior.nombre.toLowerCase() === 'recolección') {
                                        fechaFinProcesoAnterior = lote.fecha_recoleccion;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'despulpado' && procesoAnterior.datosEtapa.fecha_despulpado) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_despulpado;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'fermentación y lavado' && procesoAnterior.datosEtapa.fecha_lavado) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_lavado;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'zarandeo' && procesoAnterior.datosEtapa.fecha_zarandeo) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_zarandeo;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'secado' && procesoAnterior.datosEtapa.fecha_fin) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_fin;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'clasificación' && procesoAnterior.datosEtapa.fecha_clasificacion) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_clasificacion;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'trilla' && procesoAnterior.datosEtapa.fecha_trilla) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_trilla;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'tueste' && procesoAnterior.datosEtapa.fecha_tueste) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_tueste;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'molienda' && procesoAnterior.datosEtapa.fecha_molienda) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_molienda;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'empacado' && procesoAnterior.datosEtapa.fecha_empacado) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_empacado;
                                    } else if (procesoAnterior.nombre.toLowerCase() === 'control de calidad' && procesoAnterior.datosEtapa.fecha_control) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_control;
                                    } else if (procesoAnterior.datosEtapa.fecha_fin) {
                                        fechaFinProcesoAnterior = procesoAnterior.datosEtapa.fecha_fin;
                                    }
                                }
                            %>
                            <% if (fechaFinProcesoAnterior) { %>
                                <p class="card-text mb-3">
                                    <strong><i class="fas fa-clock text-secondary me-1"></i> Proceso anterior finalizado:</strong> <%= new Date(fechaFinProcesoAnterior).toLocaleString("es-CO") %>
                                </p>
                            <% } %>
                        <% } %>
                        
                                                <% if (proceso.nombre.toLowerCase() === 'recolección') { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha Recolección:</strong> <%= new Date(lote.fecha_recoleccion).toLocaleDateString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-coffee text-secondary me-1"></i> Tipo de Café:</strong> <%= lote.tipo_cafe %></p>
                            <p class="mb-1"><strong><i class="fas fa-hand-paper text-secondary me-1"></i> Tipo Recolección:</strong> <%= lote.tipo_recoleccion %></p>
                            <p class="mb-1"><strong><i class="fas fa-weight-hanging text-secondary me-1"></i> Peso Inicial:</strong> <%= lote.peso_inicial %> kg</p>
                            <% if (lote.observaciones) { %>
                                <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= lote.observaciones %></small></p>
                            <% } %>
                            
                            <!-- Información sobre corrección de datos -->
                            <div class="correction-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Corrección de datos:</strong> Solo disponible si:
                                <ul class="mb-0 mt-1">
                                    <li>No hay procesos posteriores registrados</li>
                                    <li>Está dentro de las 48 horas de creación</li>
                                    <li>El proceso actual es Recolección</li>
                                </ul>
                            </div>
                        <% } %>
                                                
                        <% if (proceso.nombre.toLowerCase() === 'despulpado') { %>
                            <hr>
                            <% if (proceso.datosEtapa) { %>
                                <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Remojo:</strong> <%= new Date(proceso.datosEtapa.fecha_remojo).toLocaleString("es-CO") %></p>
                                <p class="mb-1"><strong><i class="fas fa-calendar-check text-secondary me-1"></i> Despulpado:</strong> <%= new Date(proceso.datosEtapa.fecha_despulpado).toLocaleString("es-CO") %></p>
                                <p class="mb-1"><strong><i class="fas fa-weight-hanging text-secondary me-1"></i> Peso Inicial (Lote):</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                                <p class="mb-1"><strong><i class="fas fa-balance-scale text-secondary me-1"></i> Peso Final (Desp.):</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                                <% if (proceso.datosEtapa.observaciones) { %>
                                    <% 
                                        let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                        let procesoCorregido = false;
                                        
                                        if (observacionesFiltradas) {
                                            procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                            
                                            const lineas = observacionesFiltradas.split('\n');
                                            const lineasFiltradas = lineas.filter(linea => 
                                                !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                                linea.trim() !== ''
                                            );
                                            observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                        }
                                    %>
                                    
                                    <% if (procesoCorregido) { %>
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-edit me-1"></i>
                                            <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                        </div>
                                    <% } %>
                                    
                                    <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                        <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                    <% } %>
                                <% } %>
                            <% } else { %>
                                <p class="text-muted"><i class="fas fa-info-circle me-1"></i> No se ha registrado el proceso de despulpado aún.</p>
                            <% } %>
                        <% } %>
                        
                        <% if (proceso.nombre.toLowerCase() === 'fermentación y lavado' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-hourglass-start text-secondary me-1"></i> Inicio Fermentación:</strong> <%= new Date(proceso.datosEtapa.fecha_inicio_fermentacion).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-tint text-secondary me-1"></i> Lavado:</strong> <%= new Date(proceso.datosEtapa.fecha_lavado).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial (Post-Desp.):</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                            <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final (Post-Lavado):</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                        
                        <% if (proceso.nombre.toLowerCase() === 'zarandeo' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-day text-secondary me-1"></i> Fecha Zarandeo:</strong> <%= new Date(proceso.datosEtapa.fecha_zarandeo).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial (Post-Lavado):</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                            <p class="mb-1"><strong><i class="fas fa-balance-scale text-secondary me-1"></i> Peso Final (Post-Zarandeo):</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'secado' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha Inicio:</strong> <%= new Date(proceso.datosEtapa.fecha_inicio).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-cogs text-secondary me-1"></i> Método:</strong> <%= proceso.datosEtapa.metodo_secado %></p>
                            <% if (proceso.datosEtapa.humedad_inicial) { %>
                                <p class="mb-1"><strong><i class="fas fa-tint text-secondary me-1"></i> Humedad Inicial:</strong> <%= proceso.datosEtapa.humedad_inicial %>%</p>
                            <% } %>
                            <% if (proceso.datosEtapa.fecha_fin) { %>
                                <p class="mb-1"><strong><i class="fas fa-calendar-check text-secondary me-1"></i> Fecha Fin:</strong> <%= new Date(proceso.datosEtapa.fecha_fin).toLocaleString("es-CO") %></p>
                                <p class="mb-1"><strong><i class="fas fa-weight-hanging text-secondary me-1"></i> Peso Final:</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                            <% } %>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>

                                                        <% if (proceso.nombre.toLowerCase() === 'secado' && proceso.datosEtapa && typeof seguimientosSecado !== 'undefined' && seguimientosSecado.length > 0) { %>
                                <hr>
                                <h6 class="mb-2"><i class="fas fa-history me-1"></i> Historial de Seguimiento</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Temperatura (°C)</th>
                                                <th>Humedad (%)</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% seguimientosSecado.forEach(seguimiento => { %>
                                                <tr>
                                                    <td><%= new Date(seguimiento.fecha).toLocaleString("es-CO") %></td>
                                                    <td><%= seguimiento.temperatura || '-' %></td>
                                                    <td><%= seguimiento.humedad || '-' %></td>
                                                    <td><%= seguimiento.observaciones || "-" %></td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            <% } %>
                        <% } else if (proceso.nombre.toLowerCase() === 'secado') { %>
                            <hr>
                            <p class="text-muted"><i class="fas fa-info-circle me-1"></i> No se ha iniciado el proceso de secado aún.</p>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'secado' && proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2) { %>
                            <a href="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/secado/seguimiento" class="btn btn-info btn-sm">
                                <i class="fas fa-thermometer-half me-1"></i> Agregar Seguimiento
                            </a>
                        <% } %>
                        <% if (proceso.nombre.toLowerCase() === 'clasificación' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha:</strong> <%= new Date(proceso.datosEtapa.fecha_clasificacion).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial:</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                            <% if (proceso.datosEtapa.peso_total) { %>
                                <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Total:</strong> <%= proceso.datosEtapa.peso_total %> kg</p>
                            <% } %>
                            <% if (proceso.datosEtapa.peso_pergamino) { %>
                                <p class="mb-1"><strong><i class="fas fa-weight-hanging text-secondary me-1"></i> Peso Pergamino:</strong> <%= proceso.datosEtapa.peso_pergamino %> kg</p>
                            <% } %>
                            <% if (proceso.datosEtapa.peso_pasilla) { %>
                                <p class="mb-1"><strong><i class="fas fa-trash-alt text-secondary me-1"></i> Peso Pasilla:</strong> <%= proceso.datosEtapa.peso_pasilla %> kg</p>
                            <% } %>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'trilla' && proceso.datosEtapa && (proceso.datosEtapa.id_estado_proceso === 3 || proceso.datosEtapa.id_estado_proceso === 1 || proceso.datosEtapa.id_estado_proceso === 2)) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha:</strong> <%= new Date(proceso.datosEtapa.fecha_trilla).toLocaleString("es-CO") %></p>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial Pergamino:</strong> <%= proceso.datosEtapa.peso_pergamino_inicial %> kg</p>
                                    <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial Pasilla:</strong> <%= proceso.datosEtapa.peso_pasilla_inicial %> kg</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final Pergamino:</strong> <%= proceso.datosEtapa.peso_pergamino_final %> kg</p>
                                    <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final Pasilla:</strong> <%= proceso.datosEtapa.peso_pasilla_final %> kg</p>
                                </div>
                            </div>
                            <p class="mb-1"><strong><i class="fas fa-calculator text-secondary me-1"></i> Peso Total Final:</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'tueste' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha Registro:</strong> <%= new Date(proceso.datosEtapa.fecha_tueste).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial Total:</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                            
                            <% if (proceso.datosEtapa.peso_pergamino_inicial) { %>
                                <div class="mt-2 mb-2 border-start border-3 border-success ps-2">
                                    <h6 class="mb-2"><i class="fas fa-coffee text-success"></i> Café Pergamino</h6>
                                    <p class="mb-1 ms-2"><strong>Peso Inicial:</strong> <%= proceso.datosEtapa.peso_pergamino_inicial %> kg</p>
                                    <p class="mb-1 ms-2"><strong>Calidad:</strong> <%= proceso.datosEtapa.tipo_calidad_pergamino %></p>
                                    <p class="mb-1 ms-2"><strong>Nivel de Tueste:</strong> <%= proceso.datosEtapa.nivel_tueste_pergamino %></p>
                                    <p class="mb-1 ms-2"><strong>Fecha:</strong> <%= new Date(proceso.datosEtapa.fecha_tueste_pergamino).toLocaleString("es-CO") %></p>
                                    <p class="mb-1 ms-2"><strong>Peso Final:</strong> <%= proceso.datosEtapa.peso_pergamino_final %> kg</p>
                                </div>
                            <% } %>
                            
                            <% if (proceso.datosEtapa.peso_pasilla_inicial) { %>
                                <div class="mt-2 mb-2 border-start border-3 border-warning ps-2">
                                    <h6 class="mb-2"><i class="fas fa-coffee text-warning"></i> Café Pasilla</h6>
                                    <p class="mb-1 ms-2"><strong>Peso Inicial:</strong> <%= proceso.datosEtapa.peso_pasilla_inicial %> kg</p>
                                    <p class="mb-1 ms-2"><strong>Calidad:</strong> <%= proceso.datosEtapa.tipo_calidad_pasilla %></p>
                                    <p class="mb-1 ms-2"><strong>Nivel de Tueste:</strong> <%= proceso.datosEtapa.nivel_tueste_pasilla %></p>
                                    <p class="mb-1 ms-2"><strong>Fecha:</strong> <%= new Date(proceso.datosEtapa.fecha_tueste_pasilla).toLocaleString("es-CO") %></p>
                                    <p class="mb-1 ms-2"><strong>Peso Final:</strong> <%= proceso.datosEtapa.peso_pasilla_final %> kg</p>
                                </div>
                            <% } %>
                            
                            <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final Total:</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                            
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'molienda' && proceso.datosEtapa) { %>
                            <hr>
                            <% if (Array.isArray(proceso.datosEtapa) && proceso.datosEtapa.length > 0) { %>
                                <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha Molienda General:</strong> <%= new Date(proceso.datosEtapa[0].fecha_molienda).toLocaleString("es-CO") %></p>
                                
                                <% const moliendasPergamino = proceso.datosEtapa.filter(m => m.tipo_cafe === 'Pergamino' && m.id_estado_proceso === 3); %>
                                <% const moliendasPasilla = proceso.datosEtapa.filter(m => m.tipo_cafe === 'Pasilla' && m.id_estado_proceso === 3); %>

                                <% if (moliendasPergamino.length > 0) { %>
                                    <div class="mt-3 mb-2 border-start border-3 border-info ps-2">
                                        <h6 class="mb-2"><i class="fas fa-coffee text-info"></i> Café Pergamino</h6>
                                        <% moliendasPergamino.forEach(mP => { %>
                                            <% if (mP.es_grano) { %>
                                                <p class="mb-1 ms-2"><strong><i class="fas fa-seedling text-success me-1"></i>Mantenido en Grano:</strong> <%= mP.peso_final %> kg</p>
                                            <% } else { %>
                                                <p class="mb-1 ms-2"><strong><i class="fas fa-mortar-pestle text-primary me-1"></i>Molido (<%= mP.tipo_molienda %>):</strong> <%= mP.peso_final %> kg (Inicial: <%= mP.peso_inicial %> kg)</p>
                                            <% } %>
                                        <% }); %>
                                    </div>
                                <% } %>
                                
                                <% if (moliendasPasilla.length > 0) { %>
                                    <div class="mt-3 mb-2 border-start border-3 border-warning ps-2">
                                        <h6 class="mb-2"><i class="fas fa-coffee text-warning"></i> Café Pasilla</h6>
                                        <% moliendasPasilla.forEach(mPa => { %>
                                            <% if (mPa.es_grano) { %>
                                                <p class="mb-1 ms-2"><strong><i class="fas fa-seedling text-success me-1"></i>Mantenido en Grano:</strong> <%= mPa.peso_final %> kg</p>
                                            <% } else { %>
                                                <p class="mb-1 ms-2"><strong><i class="fas fa-mortar-pestle text-primary me-1"></i>Molido (<%= mPa.tipo_molienda %>):</strong> <%= mPa.peso_final %> kg (Inicial: <%= mPa.peso_inicial %> kg)</p>
                                            <% } %>
                                        <% }); %>
                                    </div>
                                <% } %>

                                <% 
                                let pesoTotalFinalMolienda = 0;
                                proceso.datosEtapa.forEach(m => {
                                    if (m.id_estado_proceso === 3 && m.peso_final) {
                                        pesoTotalFinalMolienda += parseFloat(m.peso_final);
                                    }
                                });
                                if (pesoTotalFinalMolienda > 0) { %>
                                    <p class="mb-1 mt-2"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final Total (Grano + Molido):</strong> <%= pesoTotalFinalMolienda.toFixed(2) %> kg</p>
                                <% } %>
                                
                                <% 
                                const primerRegistroConObs = proceso.datosEtapa.find(m => m.observaciones && m.id_estado_proceso === 3);
                                if (primerRegistroConObs && primerRegistroConObs.observaciones) { 
                                    let observacionesComunes = primerRegistroConObs.observaciones.split(' [')[0]; // Tomar solo la parte general antes de los detalles tipo [Pergamino Molido Fino]
                                %>
                                    <% if (observacionesComunes.trim()) { %>
                                        <p class="mb-1 mt-2 fst-italic"><small><strong>Obs. Generales:</strong> <%= observacionesComunes %></small></p>
                                    <% } %>
                                <% } %>
                            <% } else if (proceso.datosEtapa) { %>
                                <p class="mb-1"><strong><i class="fas fa-calendar-alt text-secondary me-1"></i> Fecha Molienda:</strong> <%= new Date(proceso.datosEtapa.fecha_molienda).toLocaleString("es-CO") %></p>
                                <p class="mb-1"><strong><i class="fas fa-weight text-secondary me-1"></i> Peso Inicial:</strong> <%= proceso.datosEtapa.peso_inicial %> kg</p>
                                <% if (proceso.datosEtapa.es_grano) { %>
                                    <p class="mb-1"><strong><i class="fas fa-seedling text-success me-1"></i>Tipo:</strong> Mantenido en Grano</p>
                                <% } else { %>
                                    <p class="mb-1"><strong><i class="fas fa-mortar-pestle text-primary me-1"></i> Tipo de Molienda:</strong> <%= proceso.datosEtapa.tipo_molienda %></p>
                                <% } %>
                                <p class="mb-1"><strong><i class="fas fa-balance-scale-right text-secondary me-1"></i> Peso Final:</strong> <%= proceso.datosEtapa.peso_final %> kg</p>
                                <% if (proceso.datosEtapa.observaciones) { %>
                                    <% 
                                        let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                        let procesoCorregido = false;
                                        
                                        if (observacionesFiltradas) {
                                            procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                            
                                            const lineas = observacionesFiltradas.split('\n');
                                            const lineasFiltradas = lineas.filter(linea => 
                                                !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                                linea.trim() !== ''
                                            );
                                            observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                        }
                                    %>
                                    
                                    <% if (procesoCorregido) { %>
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-edit me-1"></i>
                                            <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                        </div>
                                    <% } %>
                                    
                                    <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                        <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                    <% } %>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'empacado' && proceso.datosEtapa) { %>
                            <hr>
                            <% if (proceso.datosEtapa.empacados && Array.isArray(proceso.datosEtapa.empacados)) { %>
                                <div class="mb-3">
                                    <p class="mb-2"><i class="fas fa-calendar-alt text-secondary me-1"></i> <strong>Fecha de último empacado:</strong> 
                                        <%= new Date(proceso.datosEtapa.fecha_empacado).toLocaleString("es-CO") %>
                                    </p>
                                    
                                    <p class="mb-2"><i class="fas fa-weight text-secondary me-1"></i> <strong>Peso Total Inicial:</strong> 
                                        <%= proceso.datosEtapa.peso_inicial ? parseFloat(proceso.datosEtapa.peso_inicial).toFixed(2) : '0.00' %> kg
                                    </p>
                                    
                                    <p class="mb-2"><i class="fas fa-weight-hanging text-secondary me-1"></i> <strong>Peso Total Empacado:</strong> 
                                        <%= proceso.datosEtapa.peso_empacado ? parseFloat(proceso.datosEtapa.peso_empacado).toFixed(2) : '0.00' %> kg
                                    </p>
                                    
                                    <p class="mb-2"><i class="fas fa-boxes text-secondary me-1"></i> <strong>Total Unidades Empacadas:</strong> 
                                        <%= proceso.datosEtapa.total_empaques || 0 %>
                                    </p>
                                </div>
                                
                                <% 
                                const empacadosGrano = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Grano' && e.id_estado_proceso === 3);
                                const empacadosMolido = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Molido' && e.id_estado_proceso === 3);
                                const empacadosPasilla = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Pasilla Molido' && e.id_estado_proceso === 3);
                                %>
                                
                                <div class="mt-3">
                                    <h6 class="mb-3">Detalle por tipo de producto</h6>
                                    
                                    <div class="row g-3">
                                        <% if (empacadosGrano.length > 0) { %>
                                            <div class="col-12">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-seedling text-success me-1"></i>
                                                    <strong>Café Pergamino en Grano</strong>
                                                </div>
                                                <div class="ms-4 mt-2">
                                                    <p class="mb-1">Empacado: <%= empacadosGrano.reduce((sum, e) => sum + parseFloat(e.peso_empacado || 0), 0).toFixed(2) %> kg</p>
                                                    <p class="mb-1">Empaques: <%= empacadosGrano.reduce((sum, e) => sum + parseInt(e.total_empaques || 0), 0) %> unidades</p>
                                                    <% try { %>
                                                        <p class="mb-1">Fecha: <%= new Date(Math.max(...empacadosGrano.map(e => new Date(e.fecha_empacado)))).toLocaleDateString("es-CO") %></p>
                                                    <% } catch (e) { %>
                                                        <p class="mb-1">Fecha: No disponible</p>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% } %>
                                        
                                        <% if (empacadosMolido.length > 0) { %>
                                            <div class="col-12">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-coffee text-info me-1"></i>
                                                    <strong>Café Pergamino Molido</strong>
                                                </div>
                                                <div class="ms-4 mt-2">
                                                    <p class="mb-1">Empacado: <%= empacadosMolido.reduce((sum, e) => sum + parseFloat(e.peso_empacado || 0), 0).toFixed(2) %> kg</p>
                                                    <p class="mb-1">Empaques: <%= empacadosMolido.reduce((sum, e) => sum + parseInt(e.total_empaques || 0), 0) %> unidades</p>
                                                    <% try { %>
                                                        <p class="mb-1">Fecha: <%= new Date(Math.max(...empacadosMolido.map(e => new Date(e.fecha_empacado)))).toLocaleDateString("es-CO") %></p>
                                                    <% } catch (e) { %>
                                                        <p class="mb-1">Fecha: No disponible</p>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% } %>
                                        
                                        <% if (empacadosPasilla.length > 0) { %>
                                            <div class="col-12">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-coffee text-warning me-1"></i>
                                                    <strong>Café Pasilla Molido</strong>
                                                </div>
                                                <div class="ms-4 mt-2">
                                                    <p class="mb-1">Empacado: <%= empacadosPasilla.reduce((sum, e) => sum + parseFloat(e.peso_empacado || 0), 0).toFixed(2) %> kg</p>
                                                    <p class="mb-1">Empaques: <%= empacadosPasilla.reduce((sum, e) => sum + parseInt(e.total_empaques || 0), 0) %> unidades</p>
                                                    <% try { %>
                                                        <p class="mb-1">Fecha: <%= new Date(Math.max(...empacadosPasilla.map(e => new Date(e.fecha_empacado)))).toLocaleDateString("es-CO") %></p>
                                                    <% } catch (e) { %>
                                                        <p class="mb-1">Fecha: No disponible</p>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                                
                                <% if (proceso.datosEtapa.observaciones) { %>
                                    <% 
                                        let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                        let procesoCorregido = false;
                                        
                                        if (observacionesFiltradas) {
                                            procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                            
                                            const lineas = observacionesFiltradas.split('\n');
                                            const lineasFiltradas = lineas.filter(linea => 
                                                !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                                linea.trim() !== ''
                                            );
                                            observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                        }
                                    %>
                                    
                                    <% if (procesoCorregido) { %>
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-edit me-1"></i>
                                            <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                        </div>
                                    <% } %>
                                    
                                    <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                        <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                    <% } %>
                                <% } %>
                            <% } else { %>
                                <p class="mb-2"><i class="fas fa-calendar-alt text-secondary me-1"></i> <strong>Fecha Empacado:</strong> 
                                    <%= new Date(proceso.datosEtapa.fecha_empacado).toLocaleString("es-CO") %>
                                </p>
                                
                                <p class="mb-2"><i class="fas fa-weight text-secondary me-1"></i> <strong>Peso Inicial:</strong> 
                                    <%= typeof proceso.datosEtapa.peso_inicial !== 'undefined' ? parseFloat(proceso.datosEtapa.peso_inicial).toFixed(2) : '0.00' %> kg
                                </p>
                                
                                <p class="mb-2"><i class="fas fa-boxes text-secondary me-1"></i> <strong>Unidades Empacadas:</strong> 
                                    <%= typeof proceso.datosEtapa.total_empaques !== 'undefined' ? proceso.datosEtapa.total_empaques : '0' %>
                                </p>
                                
                                <p class="mb-2"><i class="fas fa-weight-hanging text-secondary me-1"></i> <strong>Peso Empacado:</strong> 
                                    <%= typeof proceso.datosEtapa.peso_empacado !== 'undefined' ? parseFloat(proceso.datosEtapa.peso_empacado).toFixed(2) : '0.00' %> kg
                                </p>
                                
                                <p class="mb-2"><i class="fas fa-tag text-secondary me-1"></i> <strong>Tipo de Producto:</strong> 
                                    <%= proceso.datosEtapa.tipo_producto_empacado || 'No especificado' %>
                                </p>
                                
                                <% if (proceso.datosEtapa.observaciones) { %>
                                    <% 
                                        let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                        let procesoCorregido = false;
                                        
                                        if (observacionesFiltradas) {
                                            procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                            
                                            const lineas = observacionesFiltradas.split('\n');
                                            const lineasFiltradas = lineas.filter(linea => 
                                                !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                                linea.trim() !== ''
                                            );
                                            observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                        }
                                    %>
                                    
                                    <% if (procesoCorregido) { %>
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-edit me-1"></i>
                                            <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                        </div>
                                    <% } %>
                                    
                                    <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                        <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                    <% } %>
                                <% } %>
                            <% } %>
                        <% } %>
                                                <% if (proceso.nombre.toLowerCase() === 'control de calidad' && proceso.datosEtapa) { %>
                            <hr>
                            <p class="mb-1"><strong><i class="fas fa-calendar-check text-secondary me-1"></i> Fecha Control:</strong> <%= new Date(proceso.datosEtapa.fecha_control).toLocaleString("es-CO") %></p>
                            <p class="mb-1"><strong><i class="fas fa-vials text-secondary me-1"></i> Tipo de Control:</strong> <%= proceso.datosEtapa.tipo_control %></p>
                            <p class="mb-1"><strong><i class="fas fa-star text-secondary me-1"></i> Resultado:</strong> <%= proceso.datosEtapa.resultado_control %></p>
                            <% if (proceso.datosEtapa.puntaje_cata) { %>
                                <p class="mb-1"><strong><i class="fas fa-medal text-secondary me-1"></i> Puntaje Cata:</strong> <%= proceso.datosEtapa.puntaje_cata %></p>
                            <% } %>
                            <% if (proceso.datosEtapa.observaciones) { %>
                                <% 
                                    let observacionesFiltradas = proceso.datosEtapa.observaciones;
                                    let procesoCorregido = false;
                                    
                                    if (observacionesFiltradas) {
                                        procesoCorregido = observacionesFiltradas.includes('[CORRECCIÓN COMPLETADA]');
                                        
                                        const lineas = observacionesFiltradas.split('\n');
                                        const lineasFiltradas = lineas.filter(linea => 
                                            !linea.includes('[CORRECCIÓN COMPLETADA]') && 
                                            linea.trim() !== ''
                                        );
                                        observacionesFiltradas = lineasFiltradas.join('\n').trim();
                                    }
                                %>
                                
                                <% if (procesoCorregido) { %>
                                    <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                        <i class="fas fa-edit me-1"></i>
                                        <strong>Proceso corregido:</strong> Este proceso ha sido modificado para corregir inconsistencias en los datos.
                                    </div>
                                <% } %>
                                
                                <% if (observacionesFiltradas && observacionesFiltradas.length > 0) { %>
                                    <p class="mb-1 mt-2 fst-italic"><small><strong>Obs:</strong> <%= observacionesFiltradas %></small></p>
                                <% } %>
                            <% } %>
                        <% } %>
                        

                  
                  </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between">
                            <div>
                                <% 
                                let mostrarRegistrar = false;
                                if (proceso.nombre.toLowerCase() === 'molienda') {
                                    // Para molienda, `proceso.datosEtapa` será un array.
                                    // Mostrar "Registrar" si:
                                    // 1. No hay datos de molienda O
                                    // 2. Hay moliendas pero todas están en estado "reiniciado" (id_estado_proceso = 1) 
                                    if (!proceso.datosEtapa || proceso.datosEtapa.length === 0) {
                                        mostrarRegistrar = true;
                                    } else if (proceso.datosEtapa.length > 0 && proceso.datosEtapa.every(m => m.id_estado_proceso === 1)) {
                                        mostrarRegistrar = true;
                                    }
                                } else {
                                    // Lógica original para otros procesos
                                    if (urlFormulario !== '#' && 
                                        (!proceso.datosEtapa || proceso.datosEtapa.id_estado_proceso === 1) && 
                                        !(proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2)) {
                                        mostrarRegistrar = true;
                                    }
                                }
                                %>
                                <% if (mostrarRegistrar) { %>
                                    <a href="<%= urlFormulario %>" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus-circle me-1"></i> Registrar
                                    </a>
                                <% } %>
                                <% if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2 && proceso.nombre.toLowerCase() === 'trilla') { %>
                                    <a href="<%= urlFormulario %>" class="btn btn-warning btn-sm">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </a>
                                <% } %>
                                <% if (urlAccionAdicional) { %>
                                    <a href="<%= urlAccionAdicional %>" class="btn btn-warning btn-sm">
                                        <i class="fas fa-flag-checkered me-1"></i> <%= textoAccionAdicional %>
                                    </a>
                                <% } %>
                            </div>
                            
                            <% 
                            let mostrarDropdownGeneral = false;
                            if (proceso.nombre.toLowerCase() === 'molienda') {
                                // Para molienda, el dropdown se muestra si hay al menos una molienda terminada (estado 3)
                                if (proceso.datosEtapa && proceso.datosEtapa.some(m => m.id_estado_proceso === 3)) {
                                    mostrarDropdownGeneral = true;
                                }
                            } else {
                                // Lógica original para otros procesos
                                if (proceso.datosEtapa && 
                                    (proceso.datosEtapa.id_estado_proceso === 3 || proceso.datosEtapa.id_estado_proceso === 1) && 
                                    proceso.nombre.toLowerCase() !== 'secado') {
                                    mostrarDropdownGeneral = true;
                                }
                            }
                            %>
                            <% if (mostrarDropdownGeneral) { %>

                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton<%= proceso.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton<%= proceso.id %>">
                                        <% if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 3 && proceso.nombre.toLowerCase() !== 'secado' && proceso.nombre.toLowerCase() !== 'molienda' && proceso.nombre.toLowerCase() !== 'empacado') { %>
                                            <li>
                                                <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/<%= proceso.nombre.toLowerCase().replace(/\s/g, '-') %>/<%= proceso.datosEtapa.id %>/reiniciar" method="POST">
                                                    <button type="submit" class="dropdown-item text-warning">
                                                        <i class="fas fa-redo-alt me-1"></i> Reiniciar Proceso
                                                    </button>
                                                </form>
                                            </li>
                                        <% } %>
                                        <% if (proceso.nombre.toLowerCase() === 'molienda') { %>
                                            <% if (proceso.datosEtapa && Array.isArray(proceso.datosEtapa)) { %>
                                                <% // Si hay al menos una molienda completada, mostrar opción de reiniciar el proceso completo
                                                const hayMoliendaCompletada = proceso.datosEtapa.some(m => m.id_estado_proceso === 3);
                                                if (hayMoliendaCompletada) { %>
                                                <li>
                                                    <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/molienda/reiniciar" method="POST">
                                                        <button type="submit" class="dropdown-item text-danger">
                                                            <i class="fas fa-redo-alt me-1"></i> Reiniciar Proceso de Molienda
                                                        </button>
                                                    </form>
                                                </li>
                                                <% } %>
                                            <% } %>
                                        <% } %>
                                        <% if (proceso.nombre.toLowerCase() === 'empacado' && proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 3) { %>
                                            <% if (proceso.datosEtapa.empacados && Array.isArray(proceso.datosEtapa.empacados)) { %>

                                                <% 
                                                const empacadosGrano = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Grano' && e.id_estado_proceso === 3);
                                                const empacadosMolido = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Molido' && e.id_estado_proceso === 3);
                                                const empacadosPasilla = proceso.datosEtapa.empacados.filter(e => e.tipo_producto_empacado === 'Pasilla Molido' && e.id_estado_proceso === 3);
                                                %>
                                                
                                                <% if (empacadosGrano.length > 0) { %>
                                                    <li>
                                                        <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/empacado/<%= empacadosGrano[0].id %>/reiniciar" method="POST">
                                                            <button type="submit" class="dropdown-item text-success">
                                                                <i class="fas fa-redo-alt me-1"></i> Reiniciar Empacado de Grano
                                                            </button>
                                                        </form>
                                                    </li>
                                                <% } %>
                                                
                                                <% if (empacadosMolido.length > 0) { %>
                                                    <li>
                                                        <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/empacado/<%= empacadosMolido[0].id %>/reiniciar" method="POST">
                                                            <button type="submit" class="dropdown-item text-info">
                                                                <i class="fas fa-redo-alt me-1"></i> Reiniciar Empacado de Molido
                                                            </button>
                                                        </form>
                                                    </li>
                                                <% } %>
                                                
                                                <% if (empacadosPasilla.length > 0) { %>
                                                    <li>
                                                        <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/empacado/<%= empacadosPasilla[0].id %>/reiniciar" method="POST">
                                                            <button type="submit" class="dropdown-item text-warning">
                                                                <i class="fas fa-redo-alt me-1"></i> Reiniciar Empacado de Pasilla
                                                            </button>
                                                        </form>
                                                    </li>
                                                <% } %>
                                                
                                                <% if ((empacadosGrano.length + empacadosMolido.length + empacadosPasilla.length) > 1) { %>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/empacado/reiniciar-todos" method="POST">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="fas fa-redo-alt me-1"></i> Reiniciar Todos los Empacados
                                                            </button>
                                                        </form>
                                                    </li>
                                                <% } %>
                                            <% } else { %>

                                                <li>
                                                    <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/empacado/<%= proceso.datosEtapa.id %>/reiniciar" method="POST">
                                                        <button type="submit" class="dropdown-item text-warning">
                                                            <i class="fas fa-redo-alt me-1"></i> Reiniciar Proceso de Empacado
                                                        </button>
                                                    </form>
                                                </li>
                                            <% } %>
                                        <% } %>

                                    </ul>
                                </div>
                            <% } %>
                            
                            
                            <% if (proceso.datosEtapa && proceso.datosEtapa.id_estado_proceso === 2 && proceso.nombre.toLowerCase() !== 'secado') { %>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuProgreso<%= proceso.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuProgreso<%= proceso.id %>">
                                        <% if (proceso.nombre.toLowerCase() === 'trilla') { %>
                                            <li>
                                                <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/trilla/<%= proceso.datosEtapa.id %>/reiniciar" method="POST">
                                                    <button type="submit" class="dropdown-item text-warning">
                                                        <i class="fas fa-redo-alt me-1"></i> Reiniciar Proceso
                                                    </button>
                                                </form>
                                            </li>
                                        <% } %>
                                    </ul>
                                </div>
                            <% } %>
                            
                            
                            <% if (proceso.datosEtapa && proceso.nombre.toLowerCase() === 'secado' && (proceso.datosEtapa.id_estado_proceso === 1 || proceso.datosEtapa.id_estado_proceso === 2 || proceso.datosEtapa.id_estado_proceso === 3)) { %>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuSecado<%= proceso.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuSecado<%= proceso.id %>">
                                        <% if (proceso.datosEtapa.id_estado_proceso === 1 || proceso.datosEtapa.id_estado_proceso === 2) { %>
                                            <li>
                                                <a href="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/secado/corregir-inicio" class="dropdown-item text-info">
                                                    <i class="fas fa-edit me-1"></i> Corregir Datos de Inicio
                                                </a>
                                            </li>
                                        <% } else if (proceso.datosEtapa.id_estado_proceso === 3) { %>
                                            <li>
                                                <form action="/fincas/<%= finca.id %>/lotes/<%= lote.id %>/secado/<%= proceso.datosEtapa.id %>/reiniciar" method="POST">
                                                    <button type="submit" class="dropdown-item text-warning">
                                                        <i class="fas fa-redo-alt me-1"></i> Reiniciar Proceso
                                                    </button>
                                                </form>
                                            </li>
                                        <% } %>
                                    </ul>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>
</div>


<link rel="stylesheet" href="/css/lotes/procesos.css">
<script src="/js/lotes/procesos.js"></script> 
